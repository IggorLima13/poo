public class Livro
{
    public int Id { get; set; }
    public string Titulo { get; set; }
    public string Autor { get; set; }
    public string ISBN { get; set; }
    public string Editora { get; set; }
    public int AnoPublicacao { get; set; }
    public bool Disponivel { get; set; } = true;
}


public abstract class Pessoa
{
    public string Nome { get; set; }
    public string CPF { get; set; }
    public string Telefone { get; set; }
    public string Email { get; set; }
}
public class Cliente : Pessoa
{
    public string Endereco { get; set; }
    public bool Regular { get; set; } = true;
    public List<Emprestimo> Historico { get; set; } = new();
}


public class Emprestimo
{
    public Livro Livro { get; set; }
    public Cliente Cliente { get; set; }
    public DateTime DataEmprestimo { get; set; }
    public DateTime DataPrevistaDevolucao { get; set; }
    public DateTime? DataDevolucao { get; set; }

    public decimal CalcularMulta()
    {
        if (DataDevolucao == null) return 0;

        int diasAtraso = (DataDevolucao.Value - DataPrevistaDevolucao).Days;
        return diasAtraso > 0 ? diasAtraso * 2.0m : 0;
    }
}


public interface ILivroRepository
{
    void Adicionar(Livro livro);
    List<Livro> Listar();
    Livro BuscarPorISBN(string isbn);
}


public class LivroRepository : ILivroRepository
{
    private readonly List<Livro> livros = new();

    public void Adicionar(Livro livro) => livros.Add(livro);

    public List<Livro> Listar() => livros;

    public Livro BuscarPorISBN(string isbn)
        => livros.FirstOrDefault(l => l.ISBN == isbn);
}


public class BibliotecaService
{
    private readonly ILivroRepository livroRepo;

    public BibliotecaService(ILivroRepository repo)
    {
        livroRepo = repo;
    }

    public void CadastrarLivro(Livro livro)
    {
        livroRepo.Adicionar(livro);
    }

    public List<Livro> ConsultarAcervo()
    {
        return livroRepo.Listar();
    }
}


public class EmprestimoService
{
    public Emprestimo RealizarEmprestimo(Livro livro, Cliente cliente)
    {
        if (!livro.Disponivel)
            throw new Exception("Livro indisponÃ­vel");

        livro.Disponivel = false;

        var emprestimo = new Emprestimo
        {
            Livro = livro,
            Cliente = cliente,
            DataEmprestimo = DateTime.Now,
            DataPrevistaDevolucao = DateTime.Now.AddDays(7)
        };

        cliente.Historico.Add(emprestimo);
        return emprestimo;
    }

    public decimal DevolverLivro(Emprestimo emprestimo)
    {
        emprestimo.DataDevolucao = DateTime.Now;
        emprestimo.Livro.Disponivel = true;
        return emprestimo.CalcularMulta();
    }
}

class Program
{
    static void Main()
    {
        ILivroRepository livroRepo = new LivroRepository();
        var bibliotecaService = new BibliotecaService(livroRepo);

        bibliotecaService.CadastrarLivro(new Livro
        {
            Titulo = "Clean Code",
            Autor = "Robert C. Martin",
            ISBN = "123",
            Editora = "Prentice Hall",
            AnoPublicacao = 2008
        });

        Console.WriteLine("ðŸ“š Acervo da Biblioteca:");
        foreach (var livro in bibliotecaService.ConsultarAcervo())
        {
            Console.WriteLine($"{livro.Titulo} - {livro.Autor}");
        }
    }
}


public class RelatorioService
{
    public void LivrosMaisEmprestados(List<Cliente> clientes)
    {
        var ranking = clientes
            .SelectMany(c => c.Historico)
            .GroupBy(e => e.Livro.Titulo)
            .OrderByDescending(g => g.Count());

        foreach (var item in ranking)
            Console.WriteLine($"{item.Key} - {item.Count()} emprÃ©stimos");
    }
}
